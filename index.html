<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="js/jquery.js"></script>
    <script src="js/jquery.facedetection.min.js"></script>
    <title>Carômetro - Pensi</title>
    <link href="css/style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<header>
    <div id="logo" class="hidden"><img width="100" src="logo/pensi.png" id="logo"/></div>
</header>
    <form >
        <div id="formulario">
            <div>
                <input id="arq" type="file" accept="image/*" multiple>
            </div>
            <div></div><div></div>
            <div>
                <p>
                    Colunas:
                    <input type="number" id="col" inputmode="numeric" max="8" min="1" value="6">
                </p>
                <p>
                    Título:
                    <input id="titulo" type="text">
                </p>
            </div>
            <div>Reconhecimento Facial
                <input type="radio" id="no" name="faceRec" value="false" checked>
                <label for="no">Não</label>
                <input type="radio" id="yes" name="faceRec" value="true">
                <label for="yes">Sim</label>
            </div>
            <div>
                <input id="btn" type="button" value="Gerar Carômetro">
            </div>
        </div>
    </form>
    <div id="preview"></div>
<script src="js/imageCrop.js"></script>
<script>
    const btn = document.getElementById("btn");
    const input = document.getElementById("arq");
    const titulo = document.getElementById("titulo");
    const preview = document.getElementById("preview");
    const logo = document.getElementById('logo');
    const colunas = document.getElementById("col");
    const radio = document.getElementById('yes');
    const pag = {w:"21cm",h:"28.5cm"}

    const fileTypes = [
        'image/jpeg',
        'image/pjpeg',
        'image/png'
    ]
    
    function validFileType(file) {
    for(var i = 0; i < fileTypes.length; i++) {
        if(file.type === fileTypes[i]) {
        return true;
        }
    }

    return false;
    }
    function updateImageDisplay() {
        while(preview.firstChild) {
        preview.removeChild(preview.firstChild);
        }
    
        var curFiles = input.files;
        if(curFiles.length === 0) {
        var para = document.createElement('span');
        para.textContent = 'Nenhum arquivo de imagem selecionado';
        preview.appendChild(para);
        } else {
        var list = document.createElement('form','ul');
        preview.appendChild(list);
        for(var i = 0; i < curFiles.length; i++) {
            var listItem = document.createElement('li');
            var para = document.createElement('span');
            var nome = curFiles[i].name.split('.')[0];
            if(validFileType(curFiles[i])) {
                var image = document.createElement('img');
                para.textContent = nome;
                image.src = window.URL.createObjectURL(curFiles[i]);
                listItem.appendChild(image);
                listItem.appendChild(para);
            } else {
            para.textContent = 'Arquivo ' + curFiles[i].name + ': Não é um arquivo de imagem válido.';
            listItem.appendChild(para);
            }
    
            list.appendChild(listItem);
        }
    }
}

    function geraCarometro(){
        
        while(preview.firstChild) {
            preview.removeChild(preview.firstChild);
        }
        
        var curFiles = input.files;
        if(curFiles.length === 0) {
            var para = document.createElement('span');
            para.textContent = 'Nenhum arquivo de imagem selecionado';
            preview.appendChild(para);
        } else {
            document.body.innerHTML = '';
            var tit = document.createElement('div');
            var content = document.createElement('section');
            tit.id='cabecalho';
            logo.classList.remove('hidden');
            tit.appendChild(logo);
            if (tit.innerHTML=='') tit.innerHTML+='<div id="texto">CARÔMETRO</div>'
            else tit.innerHTML += `<div id="texto">${titulo.value}</div>`;
            content.id = 'sec';
            content.style.width = pag.w;
            content.style.height = pag.h;
            content.style.pageBreakAfter = 'always';
            document.body.appendChild(content);
            content.appendChild(tit);
            for(var i = 0; i < curFiles.length; i++) {
                var listItem = document.createElement('div');
                if(i % Number(colunas.value)==0){
                    var list = document.createElement('div')
                    list.className="container";
                    list.id=`div${Number.parseInt(i/Number(colunas.value))}`
                    content.appendChild(list);
                } 

                if(validFileType(curFiles[i])) {

                    var para = document.createElement('p');
                    var nome = curFiles[i].name.split('.')[0];
                    var img = document.createElement('img');
                    var imgSizeW = Number(content.style.width.split('cm')[0])/Number(colunas.value)-0.5;
                    para.textContent = nome;
                    listItem.style.width = imgSizeW+"cm";
                    listItem.className = "box";
                    list.style.paddingLeft = ((Number(pag.w.split('cm')[0]) - ((imgSizeW+0.25) * Number(colunas.value))) / 2) + "cm"
                    img.style.width = imgSizeW+"cm";
                    img.className = "imagem";
                    img.id='img'+i;
                    img.src = window.URL.createObjectURL(curFiles[i]);
                    list.appendChild(listItem);
                    listItem.appendChild(img);
                    listItem.appendChild(para);
                } else {
                    para.textContent = 'Arquivo ' + curFiles[i].name + ': Não é um arquivo de imagem válido.';
                    listItem.appendChild(para);
                }
            
                list.appendChild(listItem);
            }
            setTimeout(ajustarPag,5000);
        }
    }



function ajustarPag(){
    const img = document.getElementsByTagName('img') ;
    const p = document.getElementsByTagName('p');
    const div = document.getElementsByClassName('container');
    const section = document.getElementById('sec');
    const titulo = document.getElementById('cabecalho');
    let sec = {w:Number(section.offsetWidth),h:Number(section.offsetHeight)};
    let divH = {img:0,p:0,t:0};
    let margem = 0;
    let alturaPagina = titulo.offsetHeight;
    
    for(var i =0; i < img.length; i++){
            if (divH.img < img[i].clientHeight) {
                divH.img = Number(img[i].clientHeight);
                divH.p = Number(p[i].offsetHeight);
            }
            
    }
    margem = (sec.w-(img[0].clientWidth+11)*Number(colunas.value))/2;
    divH.t = divH.img + divH.p +10;
    for (var i=0; i < div.length;i++){
        if(alturaPagina + Number(div[i].offsetHeight + titulo.offsetHeight)  > section.offsetHeight){
            var newSec = document.createElement('section');
            var newTitulo = document.createElement('div');
            newTitulo.id = 'cabecalho';
            newTitulo.innerHTML = titulo.innerHTML;
            newSec.style.width=pag.w;
            newSec.style.height=pag.h;
            newSec.style.pageBreakAfter='always';
            document.body.appendChild(newSec);
            newSec.appendChild(newTitulo);
            alturaPagina = titulo.offsetHeight;
            for(var i2=i;i2<div.length;i2++){
                var newDiv = document.getElementById("div"+i2)
                newSec.append(newDiv);
            }
        }
        alturaPagina += Number(div[i].offsetHeight);
    }

    if (radio.checked) {
        const img = document.getElementsByClassName('imagem');
        const array = [];
        var count = 0;
        for (i in img){
            if (img[i].nodeName == 'IMG') {
                array.push(img[i]);
                count++;
            }
        }
        
        setTimeout(async function(){
            let images = await faceDetectArray(array);
            drawImages(images);
        }, count*100);
    }
}

    input.addEventListener('change', updateImageDisplay);
    btn.addEventListener('click', geraCarometro);
</script>  
</body>
</html>